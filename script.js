const _0x52ef=['wrrDtHI=','w43DoAjCscKMw6w=','DMOLIcODWcOmwooAcRvDicK2ZhvCrMKz','w7fDvMK5Xw4T','w77DrMK2XxcC','wrzCm8KtwoM=','HWTCk8KT','w7jDoMK1Th0XRcKiNcKVJ1MAVcKtdgFMw7/CoBdYCMOwLH3CusKxM8OlUcKKwrlZYcKUw64=','bjfColvCg0bDsg==','wpcXZsOEw6J4ecKT','AV/CgWk=','w6LDgcOiUinCpMKfXsKOFsOkLxt+wpUg','wrfCgMOdYMKVBcKjM8OL','w7bDlcOidivCpA==','dDfCo1Q=','fsKDd8KtQRXDtkPDuRrClA==','PsO3wpvCrMKvw77CkV9gw4MqE2ccbwhqAkE=','wq8kL8OUwozCk8OLwpvDsQ==','w73Dq8KyXQAe','w5s4wqDDhMK9wr4=','GcK3CSrCkTpOwqjDjQ==','woDCgMODwqsnw57Cl8OSw6c=','DFfDpXzDlSVuL8KhwobCkMOFw6nChHHCqh7DvWQLwoI=','wol9w4YD','OMKNBMOGwot6w698wqs=','w43DqgE=','wrgdYMKr','wq49wp0=','K2bDhUrDqSk=','w6LDlcO2eyY=','MlvDiw==','GHrDgUbDviVsJQ==','C8Odw6orwpsVMg==','FBbDqcOZwo3Dm1rDih1vCVYHwpbCjsOUwo7DiFo=','w6LDl8OhYjLCpMKfXsKx','O0zDicOH','w7XDmsOjd8K5wobCpcKN','wqMhwpPCnw==','RSPCi1rDmcOBbW7CpQ==','RxnDgiTDiFMZ','I8OiwpPCrQ==','dCHClEbDhQ==','eTTCik3DiMOb','WBnDnDjDn1E5XsKRaSdtwqs/fcOWXXXCgw==','KMOFOcKPTMO4','RhnDnzDDnVw=','w5w6wrXDjcK+','fh0Cw5k8dcKV','ey7CpA==','wpjCjyHDgFpj','O8KFw4M=','dMONwrIsRw==','HcKJHcK8w7DCtQ==','YCo3wqxg','Qjo8w6gWTw==','PsKGFMOlwr1Aw4d2wrk=','w5TDqwLCs8Kew63CusORwrs=','w7DDqsK4fwITR8K/A8KZdFMNUsKmYw==','CAEcw5lBIQ==','BcKJEMKJ','wr3Cl8ODZg==','AhbDt8OTwonDl37DkBF7GA==','JMKKGsOlwrhd','wrZiw5AEw75NcFY=','BwfDpcOYw4k=','wrw6L8OTwoY=','ST01w6IRXg==','DGPCh8KOe8Kvw7jChMKa','wrvCisOG','wobDhX7DsA==','Fk/Ch3w=','wq4Wag==','AXTCjsKcYsKi','axXDnD7Dh1M=','w6N6wozDtMOyDw==','w5gywqDDgg==','NsKOw4DCs8KOwr8/woolwpsVw7ofBEsv','C8KUJsO0wqHCqUtfGg==','Eh7DtMO/wpXDjmvDjw==','EhLDtsORwp7Dig==','w4nDnsKMTcKN','KXHDg0DDtyk=','w5HDqhXCv8KMw63Cu8Oa','McKYwobChEdz'];(function(_0x9ab3df,_0x52efeb){const _0x4cf6f5=function(_0x2d1c7d){while(--_0x2d1c7d){_0x9ab3df['push'](_0x9ab3df['shift']());}};_0x4cf6f5(++_0x52efeb);}(_0x52ef,0x8c));const _0x4cf6=function(_0x9ab3df,_0x52efeb){_0x9ab3df=_0x9ab3df-0x0;let _0x4cf6f5=_0x52ef[_0x9ab3df];if(_0x4cf6['aFyFJB']===undefined){(function(){let _0x8c0a00;try{const _0x28c704=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x8c0a00=_0x28c704();}catch(_0x4df781){_0x8c0a00=window;}const _0x9a7633='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';_0x8c0a00['atob']||(_0x8c0a00['atob']=function(_0x95d7aa){const _0x43c307=String(_0x95d7aa)['replace'](/=+$/,'');let _0x2ceeda='';for(let _0x47689e=0x0,_0x2bb6e7,_0x41b42f,_0x5a4313=0x0;_0x41b42f=_0x43c307['charAt'](_0x5a4313++);~_0x41b42f&&(_0x2bb6e7=_0x47689e%0x4?_0x2bb6e7*0x40+_0x41b42f:_0x41b42f,_0x47689e++%0x4)?_0x2ceeda+=String['fromCharCode'](0xff&_0x2bb6e7>>(-0x2*_0x47689e&0x6)):0x0){_0x41b42f=_0x9a7633['indexOf'](_0x41b42f);}return _0x2ceeda;});}());const _0x2a97e5=function(_0x158808,_0x122732){let _0xa87e70=[],_0x5e9857=0x0,_0x4dfa5b,_0x139fcb='',_0x19aa31='';_0x158808=atob(_0x158808);for(let _0x3a4bad=0x0,_0x34b551=_0x158808['length'];_0x3a4bad<_0x34b551;_0x3a4bad++){_0x19aa31+='%'+('00'+_0x158808['charCodeAt'](_0x3a4bad)['toString'](0x10))['slice'](-0x2);}_0x158808=decodeURIComponent(_0x19aa31);let _0x331eb6;for(_0x331eb6=0x0;_0x331eb6<0x100;_0x331eb6++){_0xa87e70[_0x331eb6]=_0x331eb6;}for(_0x331eb6=0x0;_0x331eb6<0x100;_0x331eb6++){_0x5e9857=(_0x5e9857+_0xa87e70[_0x331eb6]+_0x122732['charCodeAt'](_0x331eb6%_0x122732['length']))%0x100;_0x4dfa5b=_0xa87e70[_0x331eb6];_0xa87e70[_0x331eb6]=_0xa87e70[_0x5e9857];_0xa87e70[_0x5e9857]=_0x4dfa5b;}_0x331eb6=0x0;_0x5e9857=0x0;for(let _0x47567d=0x0;_0x47567d<_0x158808['length'];_0x47567d++){_0x331eb6=(_0x331eb6+0x1)%0x100;_0x5e9857=(_0x5e9857+_0xa87e70[_0x331eb6])%0x100;_0x4dfa5b=_0xa87e70[_0x331eb6];_0xa87e70[_0x331eb6]=_0xa87e70[_0x5e9857];_0xa87e70[_0x5e9857]=_0x4dfa5b;_0x139fcb+=String['fromCharCode'](_0x158808['charCodeAt'](_0x47567d)^_0xa87e70[(_0xa87e70[_0x331eb6]+_0xa87e70[_0x5e9857])%0x100]);}return _0x139fcb;};_0x4cf6['cEeHHP']=_0x2a97e5;_0x4cf6['hEFBdt']={};_0x4cf6['aFyFJB']=!![];}const _0x2d1c7d=_0x4cf6['hEFBdt'][_0x9ab3df];if(_0x2d1c7d===undefined){if(_0x4cf6['itolDX']===undefined){_0x4cf6['itolDX']=!![];}_0x4cf6f5=_0x4cf6['cEeHHP'](_0x4cf6f5,_0x52efeb);_0x4cf6['hEFBdt'][_0x9ab3df]=_0x4cf6f5;}else{_0x4cf6f5=_0x2d1c7d;}return _0x4cf6f5;};(function(){const _0x14059e=0xa;let _0x12736a;let _0x406f46='';let _0x289124='';let _0x16aee4=[];let _0x3172cb=[];let _0x5094d5;let _0xfa3419;let _0x13dec1=![];let _0x3e761c=![];function _0x460e58(_0x186399,_0x26e6dc){let _0x212dcc=0x7d0;let _0x5cb3cb=null;for(let _0x9846a0=0x0;_0x9846a0<_0x16aee4[_0x4cf6('0x10','J&sx')];_0x9846a0++){if(typeof _0x16aee4[_0x9846a0]!==_0x4cf6('0x53',')wxu')&&_0x16aee4[_0x9846a0][_0x4cf6('0x24','p5gL')]&&_0x3172cb[_0x4cf6('0x40','G3zS')](_0x9846a0)){let _0x5247a5=_0x425191(_0x5094d5,_0x16aee4[_0x9846a0]);if(_0x5247a5<_0x212dcc){_0x212dcc=_0x5247a5;_0x5cb3cb=_0x16aee4[_0x9846a0];}}}if(_0x5cb3cb!==null){_0x133ba0(_0x5cb3cb,_0x186399,_0x26e6dc);}if(!_0x13dec1){_0x186399[_0x4cf6('0x17','*SSi')]=null;}_0x186399[_0x4cf6('0x52','XXFP')]['rotation']['x']=0x0;}window[_0x4cf6('0x31','IFNp')]=new Proxy(window[_0x4cf6('0x30','m^aZ')],{'construct':function(_0x57fa6d,_0x3697ba){const _0x32a75e=new _0x57fa6d(..._0x3697ba);const _0x24a6cf=_0x1b70bb=>{console['log'](_0x4cf6('0x33','jCC8'),_0x1b70bb);};const _0x2611e9=_0x56b565=>{let _0x37673a=new Uint8Array(_0x56b565[_0x4cf6('0x26','%)Ks')]);let _0xc6a371=msgpack[_0x4cf6('0x5','*SSi')](_0x37673a);switch(_0xc6a371[0x0]){case'0':if(!_0x3e761c){_0xfa3419=_0xc6a371[0x1][_0xc6a371[0x1][_0x4cf6('0x1d','Scpq')]-0x19];console[_0x4cf6('0x37','S&CF')](_0xc6a371);console[_0x4cf6('0xc','IFNp')](_0x4cf6('0x1e','dtYn'),_0xfa3419);_0x3e761c=!![];}for(let _0x5ecbdf=0x0;_0x5ecbdf<_0xc6a371[0x1]['length'];_0x5ecbdf+=0x22){if(_0xc6a371[0x1][_0x5ecbdf+0x9]==null||_0xc6a371[0x1][_0x5ecbdf+0x9]!==_0xfa3419){_0x3172cb[_0x4cf6('0x22','J&sx')](_0xc6a371[0x1][_0x5ecbdf+0x1]);console['log'](_0xc6a371[0x1][_0x5ecbdf+0x5]+'\x20is\x20an\x20enemy');}}break;case _0x4cf6('0xf','3qI@'):_0x3e761c=![];_0x3172cb[_0x4cf6('0x46','*il1')]=0x0;break;case'k':for(let _0xa65282=0x0;_0xa65282<_0x16aee4[_0x4cf6('0x49','5nkq')];_0xa65282++){if(typeof _0x16aee4[_0xa65282]!==_0x4cf6('0x0','Scpq')){_0x16aee4[_0xa65282][_0x4cf6('0x3c','rBd9')]=![];}}for(let _0x2524e0=0x0;_0x2524e0<_0xc6a371[0x1][_0x4cf6('0x2e','q#Ss')];_0x2524e0+=0xa){_0x16aee4[_0xc6a371[0x1][_0x2524e0]]={'x':(_0xc6a371[0x1][_0x2524e0+0x1]^0x203300f)/0x3e8,'y':(_0xc6a371[0x1][_0x2524e0+0x2]^0x203300f)/0x3e8,'z':(_0xc6a371[0x1][_0x2524e0+0x3]^0x203300f)/0x3e8,'updated':!![]};}}};const _0x5a1000=_0x4ca92b=>{console[_0x4cf6('0x4c','CLa&')](_0x4cf6('0x18','Z4u('),_0x4ca92b);_0x32a75e[_0x4cf6('0x2c','cMmm')](_0x4cf6('0x44','cMmm'),_0x24a6cf);_0x32a75e[_0x4cf6('0x47','5nkq')](_0x4cf6('0x43','5nkq'),_0x2611e9);_0x32a75e[_0x4cf6('0x3d','*SSi')](_0x4cf6('0x51','hRwG'),_0x5a1000);};_0x32a75e[_0x4cf6('0x14','%ZVS')](_0x4cf6('0x2a','p5gL'),_0x24a6cf);_0x32a75e[_0x4cf6('0x27',']xfE')]('message',_0x2611e9);_0x32a75e[_0x4cf6('0x1','q#Ss')](_0x4cf6('0x9','ZxxS'),_0x5a1000);_0x32a75e[_0x4cf6('0xd','kTKc')]=new Proxy(_0x32a75e[_0x4cf6('0x36','3qI@')],{'apply':function(_0x2f5512,_0xe0dfb6,_0x4e8586){let _0x252ff5=msgpack['deserialize'](_0x4e8586[0x0]);switch(_0x252ff5[0x0]){case'entg':_0x252ff5[0x10]=0x1;_0x13dec1=![];break;case'inp':if(_0x252ff5[0x3]!==0x0){if(Object[_0x4cf6('0x3','EniZ')](_0x252ff5[0x3])['length']===0x1){for(let _0x574447 of Object[_0x4cf6('0x4','j5c&')](_0x252ff5[0x3])){let _0x502766=_0x574447['slice'](0x2);if(_0x502766==='6'){console[_0x4cf6('0x35','Scpq')](_0x13dec1?_0x4cf6('0x11','5nkq'):_0x4cf6('0x3b','BuqV'));}}}}}_0x4e8586[0x0]=new Uint8Array([...msgpack['serialize'](_0x252ff5),..._0x4e8586[0x0][_0x4cf6('0x4f','IQ%D')](_0x4e8586[0x0]['length']-0x2)]);_0x2f5512['apply'](_0xe0dfb6,_0x4e8586);}});_0x12736a=_0x32a75e;return _0x32a75e;}});function _0xfdc2ce(){console[_0x4cf6('0xc','IFNp')](_0x4cf6('0x23','q#Ss'));}function _0x425191(_0x150e23,_0x4603a1){const _0x57c9d3=_0x150e23['x']-_0x4603a1['x'];const _0x7b356e=_0x150e23['y']-_0x4603a1['y'];const _0xa187c9=_0x150e23['z']-_0x4603a1['z'];return Math[_0x4cf6('0xe','%)Ks')](_0x57c9d3*_0x57c9d3+_0x7b356e*_0x7b356e+_0xa187c9*_0xa187c9);}function _0x133ba0(_0x368c0f,_0x3fcdad,_0x593061){let _0x2e1b72=_0x368c0f['x'],_0x2eb987=_0x368c0f['y']+_0x14059e,_0x4efd9e=_0x368c0f['z'];let _0xe8b8b4=_0x13c41a(_0x3fcdad[_0x4cf6('0x12','B1W%')]['position']['x'],_0x3fcdad['object']['position']['y'],_0x3fcdad[_0x4cf6('0x20','q#Ss')][_0x4cf6('0x1a','Scpq')]['z'],_0x2e1b72,_0x2eb987,_0x4efd9e),_0x20931d=_0x2492be(_0x3fcdad[_0x4cf6('0x6',')wxu')][_0x4cf6('0x7','jCC8')]['z'],_0x3fcdad['object']['position']['x'],_0x4efd9e,_0x2e1b72);_0x3fcdad['target']={'xD':_0xe8b8b4-(0.3+_0x593061['recoilForce'])*_0x593061[_0x289124],'yD':_0x20931d,'x':_0x2e1b72,'y':_0x2eb987,'z':_0x4efd9e};if(_0x13dec1){_0x3fcdad[_0x4cf6('0x29',']xfE')](0x12c);}}function _0x13c41a(_0x58352d,_0x4a3b34,_0x4177af,_0x8eb883,_0x463ece,_0x2c1f98){let _0x840c75=Math[_0x4cf6('0x1c','G*hX')](_0x4a3b34-_0x463ece),_0x13eb7b=_0xd2008f(_0x58352d,_0x4a3b34,_0x4177af,_0x8eb883,_0x463ece,_0x2c1f98);return Math[_0x4cf6('0x41','S&CF')](_0x840c75/_0x13eb7b)*(_0x4a3b34>_0x463ece?-0x1:0x1);}function _0xd2008f(_0x436ef6,_0x4aac91,_0x3dc4f4,_0x316b1c,_0x428763,_0x270749){let _0x233833=_0x436ef6-_0x316b1c,_0x25ffde=_0x4aac91-_0x428763,_0xf0785f=_0x3dc4f4-_0x270749;return Math[_0x4cf6('0x21','Ys9#')](_0x233833*_0x233833+_0x25ffde*_0x25ffde+_0xf0785f*_0xf0785f);}function _0x2492be(_0x5bc5c5,_0x17021f,_0x2a688a,_0x278027){return Math[_0x4cf6('0x8','*SSi')](_0x17021f-_0x278027,_0x5bc5c5-_0x2a688a);}function _0x200ec6(_0x184825,_0x9aae6c,_0x48afd9,_0x1e42b5,_0x2f7ad1,_0x4e88d8,_0x161168,_0xd42304,_0x4a1970,_0x4a0e6b,_0x512c7e){if(_0x406f46&&_0x4a0e6b){_0x4a1970[_0x4cf6('0x34',')wxu')](0x46);_0x4a1970[_0x4cf6('0x50','EniZ')](0x78);for(let _0x36288f of _0xd42304[_0x4cf6('0x16','*SSi')]){_0x13dec1=_0x36288f[0x6];}if(_0x4a0e6b[_0x406f46]!=null){_0x5094d5=_0x4a0e6b[_0x406f46][_0x4cf6('0x25','PyoH')];_0x4a1970=new Proxy(_0x4a1970,{'get':function(_0x23b8c3,_0x53c052,_0x3bdcee){console[_0x4cf6('0x4e','%ZVS')]('GETTING',_0x53c052,_0x23b8c3[_0x53c052]);return _0x23b8c3[_0x53c052];},'set':function(_0x437624,_0x4e6cd1,_0x254368,_0x582d53){console[_0x4cf6('0x3a','o0y9')](_0x4cf6('0x4b','XXFP'),_0x4e6cd1,_0x254368);_0x437624[_0x4e6cd1]=_0x254368;}});_0x460e58(_0xd42304,_0x4a0e6b);}}}let _0x5e45bf=function(_0x301288){_0x301288[0x4][_0x4cf6('0x2','1GKv')]=new Proxy(_0x301288[0x4][_0x4cf6('0x4d','2B79')],{'apply':function(_0xe74d34,_0x54f0a7,_0x29b46c){_0x200ec6(...[..._0x301288,..._0x29b46c]);return _0xe74d34[_0x4cf6('0x45','*il1')](_0x54f0a7,_0x29b46c);}});};Object[_0x4cf6('0x2f','b]lY')]=new Proxy(Object[_0x4cf6('0x1f','q#Ss')],{'apply':function(_0x81988a,_0x117c39,_0x2321d5){let _0x16ca0b=arguments[_0x4cf6('0x1b','Pse@')][_0x4cf6('0x48','dtYn')];if(_0x16ca0b&&_0x16ca0b[_0x4cf6('0xb','J&sx')]['length']==0x5&&_0x16ca0b[_0x4cf6('0x3e',']xfE')][0x0][_0x4cf6('0x32','BuqV')]){_0x5e45bf(_0x16ca0b[_0x4cf6('0x28','j5c&')]);_0xfdc2ce();Object[_0x4cf6('0x38','BuqV')]=_0x81988a;}return _0x81988a[_0x4cf6('0x4a','b]lY')](_0x117c39,_0x2321d5);}});const _0x31d799=window['TextDecoder'][_0x4cf6('0x15','tW9&')][_0x4cf6('0x19','BuqV')];window[_0x4cf6('0x2b','KSky')][_0x4cf6('0x2d','ZxxS')][_0x4cf6('0xa','XXFP')]=function(..._0x329304){let _0x3328ab=_0x31d799[_0x4cf6('0x39',']xfE')](this,_0x329304);if(_0x3328ab['length']>0x100590){_0x406f46=/']\){this\['list']\[.]\['(\w+)']\['visible']=/[_0x4cf6('0x3f','o0y9')](_0x3328ab)[0x1];_0x289124=/\w*1,this\['\w+'\]=\w*0,this\['\w+'\]=\w*0,this\['\w+'\]=\w*1,this\['\w+'\]=\w*1,this\['\w+'\]=\w*0,this\['\w+'\]=\w*0,this\['(\w+)'\]=\w*0,this\['\w+'\]=\w*0,this\['\w+'\]=\w*0,this\['\w+'\]=\w*0,/[_0x4cf6('0x13','b]lY')](_0x3328ab)[0x1];console['log'](_0x4cf6('0x42','*il1'),_0x406f46);}return _0x3328ab;};}());

(function() {
    // Variables
    var frameCount = 0;
    var vars = new Map();
    var script;
    var GUI;
    var showMenu = true;
    var menuDirty = true;
    var features = [];
    var updatedFeat = new Map();
    var positions = new Map();
    var downKeys = new Set();
    var objectDirty = false;
    var mouseDownL = false, mouseDownM = false, mouseDownR = false;
    var keyDown = (key) => downKeys.has(key);
    var isProxy = Symbol("isProxy");
    const twoPI = Math.PI * 2;
    const halfPI = Math.PI / 2;

    // Initialization
    function initialize() {

        addListener(document, "mousedown", event =>{
            const Left=0, Middle=1, Right=2;
            switch(event.button) {
                case Left: mouseDownL = true; break;
                case Middle: mouseDownM = true; break;
                case Right: mouseDownR = true; break;
                default: break;
            }
        });

        addListener(document, "mouseup", event =>{
            const Left=0, Middle=1, Right=2;
            switch(event.button) {
                case Left: mouseDownL = false; break;
                case Middle: mouseDownM = false; break;
                case Right: mouseDownR = false; break;
                default: break;
            }
        });

        addListener(document, "keyup", event => {
            if (downKeys.has(event.code)) downKeys.delete(event.code)
        });

        addListener(document, "keydown", event => {
            if ('INPUT' == document.activeElement.tagName || !window.endUI && window.endUI.style.display) return;
            switch (event.code) {
                case 'F1':
                    event.preventDefault();
                    showMenu ^= 1;
                    window.SOUND.play('tick_0', 0.1);
                    menuDirty = showMenu;
                    break;
                case 'F2':
                    saveAs("game_" + getVersion() + ".js", script);
                    break;
                default:
                    if (!downKeys.has(event.code)) downKeys.add(event.code);
                    for (const feature of features) {
                        if (feature && "Digit" + feature.key == event.code) {
                            if (feature.container.length) onUpdated(feature);
                            else if (typeof feature.myFunction === "function") feature.myFunction();
                        }
                    }
                    break;
            }
        });

        // GUI Init
        GUI = document.getElementById("myGUI");
        if (GUI == null) {
            GUI = document.createElement('div');
            GUI.id = "myGUI";
            GUI.style = "float:left;width:100%;background-color: rgba(0,0,0,0.25);border-radius:5%;text-align:right;line-height:0.8;margin-top:5%;";
        }

        //Add Features
        newFeature('Chams', "3", ['Off', 'On']);
        newFeature('WireFrame', "4", ['Off', 'On']);
        newFeature('Names', "5", ['Off', 'On']);
        newFeature('Bhop', "6", ['Off', 'Auto Jump', 'Key Jump', 'Auto Slide', 'Key Slide']);
        newFeature('AutoReload', "7", ['Off', 'On']);
        newFeature('AutoAim', "8", ['On']);
        newFeature('Wallbangs', "9", ['Off', 'On']);

    }

    // Main Render Loop
    function RENDER(three, utils, colors, config, overlay, scale, game, controls, renderer, me, delta) {

        frameCount++; //frame timer
        if (frameCount >= 100000) {
            frameCount = 0;
        }

        //if (frameCount % 1000 == 0) {
        //    console.log("FRAME ", frameCount)
        //}

        if(me && renderer.scene) {
            //GUI Update
            const topLeft = document.getElementById("topLeftHolder");
            if (topLeft && GUI) {
                if (!topLeft.contains(GUI)) {
                    topLeft.appendChild(GUI);
                } else if (showMenu) {
                    if (menuDirty) {
                        menuDirty = false;
                        GUI.innerHTML = "<br><h4 style='text-align:center;color:#1E90FF;'>Krunker Java Plus 𝓧 HAX ✅</h4><hr>";
                        for (const feature of features) {
                            GUI.innerHTML += `<h5><span style='float:left;margin-left:10%;color:rgba(255,193,72,255)'>${feature.key}</span> <span style='float:left;margin-left:10%;color:rgba(255,255,255,255)'>${feature.name}</span> <span style=float:all;margin-right:10%;margin-left:10%;color:${feature.valueStr == "On" ? "#B2F252" : feature.valueStr == "Off" ? "#FF4444" : "#999EA5"};'>${feature.valueStr}</span></h5>`;
                        }
                        GUI.innerHTML += "<br>";
                    }
                } else if (GUI.innerHTML) GUI.innerHTML = null;
            }
            for (let[name, feature] of updatedFeat) {
                updatedFeat.delete(name);
            }

            // Rendering Related Features Update...

            // NameTags
            let getIsFriendly = (entity) => (me && me.team ? me.team : me.spectating ? 0x1 : 0x0) == entity.team;
            let getInView = (entity) => (null == game[vars.get("canSee").val](me, entity.pos.x, entity.pos.y, entity.pos.z, 10));
            const featureNames = getFeature('Names');
            game.players.list.filter(x => {
                return x && x.active && !x[vars.get("isYou").val] && x.hasOwnProperty('pos');
            }).forEach((player, index, array) => {
                player[vars.get("inView").val] = featureNames.value ? player.active : getIsFriendly(player) ? player.active : getInView(player);
            })

            // Chams / WireFrame
            const featureChams = getFeature('Chams');
            const featureWire = getFeature('WireFrame');
            for (const obj of renderer.scene.children) {
                if (obj instanceof three.Object3D) {
                    if (obj.name && obj.name.startsWith("playermap")) {
                        obj.visible = featureChams.value ? true : false;
                        obj.traverse(( child ) => {
                            if (child && child.type =="Mesh") {
                                child.material.depthTest = featureChams.value ? false : true;
                                child.material.opacity = featureChams.value ? 0.85 : 1.0;
                                child.material.transparent = featureChams.value ? true : false;
                                child.material.fog = featureChams.value ? false : true;
                                child.material.emissive.r = featureChams.value ? 0.25 : 0;
                                //child.material.emissive.g = featureChams.value ? 0.55 : 0;
                                child.material.emissive.b = featureChams.value ? 0.55 : 0;
                                child.material.wireframe = featureWire.value ? true : false;
                            }
                        })
                    }
                }
            }

            // camLookAt
            const featureAutoAim = getFeature('AutoAim');
            if (controls && (featureAutoAim.value > 1 || featureAutoAim.value == 1 && mouseDownR)) {
                if (void 0 == game.controls.camTarget) {
                    Object.defineProperty(controls, 'camTarget', { value: null });
                }
                else if (featureAutoAim.value == 1 && mouseDownR && controls.camTarget !== null || featureAutoAim.value > 1 && controls.camTarget !== null) {
                    const pchObjc = controls[vars.get("pchObjc").val];
                    pchObjc.rotation.x = controls.camTarget.xD;
                    pchObjc.rotation.x = Math.max(-halfPI, Math.min(halfPI, pchObjc.rotation.x));
                    controls.object.rotation.y = controls.camTarget.yD;
                    controls.yDr = pchObjc.rotation.x % Math.PI;
                    controls.xDr = controls.object.rotation.y % Math.PI;
                }
            }

            // inputs
            /*
            const isn = 0, speed = 1, ydir = 2, xdir = 3, move = 4, shoot = 5, scope = 6, jump = 7, crouch = 8, reload = 9, weaponKey = 10, weaponSwap = 11;
            if (controls.tmpInpts.length) {
                let input = controls.tmpInpts.shift();
                input[scope] = mouseDownR
                input[shoot] = mouseDownL
                const featureReload = getFeature('AutoReload');
                if (featureReload.value) {
                    let ammoLeft = me[vars.get("ammos").val][me[vars.get("weaponIndex").val]];
                    if (ammoLeft <= 1) {
                        input[reload] = 1;
                    }
                }
                frame ++;
                if (frame >= delta * 10) {
                    frame = 0;
                    //me.resetInputs();
                    me.inputs.pop();
                    me.inputs.push(input)
                }
            }*/
        }
    }

    // Main Input Loop
    function INPUTS(three, utils, colors, config, overlay, me, input, game, recon, lock) {
        const KEY = {
            frame : 0,
            delta : 1,
            xdir : 2,
            ydir : 3,
            moveDir : 4,
            shoot : 5,
            scope : 6,
            jump : 7,
            crouch : 8,
            reload : 9,
            weaponScroll : 10,
            weaponSwap : 11,
            moveLock : 12
        }

        //Auto Reload
        const featureReload = getFeature('AutoReload');
        if (featureReload.value) {
            let ammoLeft = me[vars.get("ammos").val][me[vars.get("weaponIndex").val]];
            if (ammoLeft <= 1) {
                input[KEY.reload] = 1;
            }
        }

        // bHop / slide
        const featureBhop = getFeature('Bhop');
        if (featureBhop && featureBhop.value) {
            if (keyDown("Space") || featureBhop.value !== 2 && featureBhop.value !== 4) {
                game.controls.keys[game.controls.jumpKey] ^= 1;
                game.controls.keys[game.controls.crouchKey] = (me.yVel < -0.04 && me.canSlide) && featureBhop.value !== 1 && featureBhop.value !== 2 ? 1 : 0;
            }
        }

        let camLookAt = (pos) => {
            if (pos === null || (pos.x + pos.y + pos.z) == 0) return void(game.controls.camTarget = null);
            let xdir = getXDire(game.controls.object.position.x, game.controls.object.position.y, game.controls.object.position.z, pos.x, pos.y, pos.z);
            let ydir = getDir(game.controls.object.position.z, game.controls.object.position.x, pos.z, pos.x);
            game.controls.camTarget = {
                xD:xdir,
                yD: ydir,
                x: pos.x + config.camChaseDst * Math.sin(ydir) * Math.cos(xdir),
                y: pos.y - config.camChaseDst * Math.sin(xdir),
                z: pos.z + config.camChaseDst * Math.cos(ydir) * Math.cos(xdir)
            }
        }

        let getIsFriendly = (entity) => (me && me.team ? me.team : me.spectating ? 0x1 : 0x0) == entity.team;
        let getInView = (entity) => (null == game[vars.get("canSee").val](me, entity.pos.x, entity.pos.y, entity.pos.z));
        let enemies = game.players.list.filter(x => {
            return x.active && !x[vars.get("isYou").val] && !getIsFriendly(x)
        })

        enemies.forEach((enemy, index, array) => {
            let key = enemy.sid; //game.players.indexBySid(enemy.sid);
            if (positions.has(key)) {
                let pos = positions.get(key);
                enemy.pos = new three.Vector3(pos.x, pos.y + enemy.height - config.cameraHeight - enemy[vars.get("crouchVal").val] * config.crouchDst, pos.z)
            }
        })

        let pchObjc = game.controls[vars.get("pchObjc").val];
        let ty = game.controls.object.rotation.y;
        let tx = pchObjc.rotation.x;

        let target = enemies.filter(x => {
            return x.hasOwnProperty('pos') && getInView(x)
        }).sort((p1, p2) => p1.pos.distanceToSquared(me) - p2.pos.distanceToSquared(me)).shift();

        // bHop / slide
        const featureAutoAim = getFeature('AutoAim');
        //newFeature('AutoAim', "8", ['Off', 'Assist', 'Silent', 'IDGAF']);
        if (featureAutoAim.value && target) {
            if (featureAutoAim.value !== 2) camLookAt(target.pos);
            if (featureAutoAim.value > 1) {
                if (me.weapon[vars.get("nAuto").val] && me[vars.get("didShoot").val]) {
                    input[KEY.shoot] = 0;
                } else if (!me[vars.get("aimVal").val]) {
                    input[KEY.scope] = 1;
                    input[KEY.shoot] = 1;
                } else {
                    input[KEY.scope] = 1;
                }
            }

            ty = getDir(game.controls.object.position.z, game.controls.object.position.x, target.pos.z, target.pos.x);
            tx = getXDire(game.controls.object.position.x, game.controls.object.position.y, game.controls.object.position.z, target.pos.x, target.pos.y, target.pos.z);
            tx -= (0.3 + me.recoilForce) * me[vars.get("recoilAnimY").val];
        }
        else {
            camLookAt(null);
            //input[KEY.scope] = 0;
        }
        // silent aim
        if (featureAutoAim.value) {
        }
    }


    // Set Variable Object Entries
    let setVars = function() {
        vars
        .set("xDire", {regex:/this\['(\w+)']=\w+\['round']\(0x3\),this\['\w+']=\w+\['round']\(0x3\)/,pos:1})
        .set("yDire", {regex:/this\['(\w+)']>Math\['PI']\/0x2\?this\['\w+']=Math\['PI']\/0x2/,pos:1})
        .set("isYou", {regex:/this\['\w+']=k,this\['(\w+)']=w,this\['\w+']=!0x0/,pos:1})
        .set("inView", {regex:/if\(!\w+\['(\w+)']\)continue/,pos:1})
        .set("ammos", {regex:/\['noReloads']\|\|!\w\['\w+']&&\w\['(\w+)']/,pos:1})
        .set("weaponIndex", {regex:/\['noReloads']\|\|!\w\['\w+']&&\w\['\w+']\[\w\['(\w+)']]/,pos:1})
        .set("procInputs", {regex:/this\['(\w+)']=function\((\w+),(\w+),\w+,\w+\){(this)\['recon']/,pos:1})
        .set("swapWeapon", {regex:/\w+\['(\w+)']\(this,null,null,void 0x0,0x0,\w+\):\w+\[0xa]&&\w+\['\w+']\(this,\w+\[0xa],!0x1,void 0x0,void 0x0,\w+\)/,pos:1})
        .set("aimVal", {regex:/&&0x1==\w\['(\w+)']&&!\w/,pos:1})
        .set("pchObjc", {regex:/0x0,this\['(\w+)']=new \w+\['Object3D']\(\),this/,pos:1})
        .set("didShoot", {regex:/--,\w+\['(\w+)']=!0x0/,pos:1})
        .set("nAuto", {regex:/'(\w+)':!0x0,'burst':/,pos:1})
        .set("crouchVal", {regex:/this\['(\w+)']\+=\w\['crouchSpeed']\*\w+,0x1<=this\['\w+']/,pos:1})
        .set("recoilAnimY", {regex:/\w*1,this\['\w+'\]=\w*0,this\['\w+'\]=\w*0,this\['\w+'\]=\w*1,this\['\w+'\]=\w*1,this\['\w+'\]=\w*0,this\['\w+'\]=\w*0,this\['(\w+)'\]=\w*0,this\['\w+'\]=\w*0,this\['\w+'\]=\w*0,this\['\w+'\]=\w*0,/,pos:1})
        .set("canSee", {regex:/this\['(\w+)']=function\(\w+,\w+,\w+,\w+,\w+,\w+\){if\(!\w+\)return!0x1;/,pos:1})

        for (const [name, object] of vars.entries()) {
            let result = object.regex.exec(script);
            if ( result ) {
                object.val = result[object.pos];
                console.log("found: ", name, " at ", result.index, " value: ", object.val);
            } else {
                object.val = null;
                alert("Failed to find ", name);
            }
        }
    }

    // Decode The Vries
    let decodeText = function(str, array, xor) {
        for (var i = 0, il = array.byteLength; i < il; i ++) {
            str += String.fromCharCode(array.getUint8(i) ^ xor);
        }
        try {
            return decodeURIComponent( escape( str ) );
        } catch ( e ) {
            return str;
        }
    }

    // Get the game patch number
    let getVersion = function() {
        const elems = document.getElementsByClassName('terms');
        const version = elems[elems.length - 1].innerText;
        return version;
    }

    // Save Data to Disk
    let saveAs = function(name, data) {
        let blob = new Blob([data], {type: 'text/plain'});
        let el = window.document.createElement("a");
        el.href = window.URL.createObjectURL(blob);
        el.download = name;
        document.body.appendChild(el);
        el.click();
        document.body.removeChild(el);
    }

    // Check if Something is Defined
    let isDefined = function(object) {
        return void 0 !== object;
    }

    // Check if Something is a type
    let isType = function(item, type) {
        return typeof item === type;
    }

    // Various utility functions...
    let getD3D = function(x1, y1, z1, x2, y2, z2) {
        var dx = x1 - x2;
        var dy = y1 - y2;
        var dz = z1 - z2;
        return Math.sqrt(dx * dx + dy * dy + dz * dz);
    };
    let getAngleDst = function (a, b) {
        return Math.atan2(Math.sin(b - a), Math.cos(a - b));
    };
    let getXDire = function(x1, y1, z1, x2, y2, z2) {
        var h = Math.abs(y1 - y2);
        var dst = getD3D(x1, y1, z1, x2, y2, z2);
        return (Math.asin(h / dst) * ((y1 > y2)?-1:1));
    };
    let getDir = function (x1, y1, x2, y2) {
        return Math.atan2(y1 - y2, x1 - x2);
    };
    let lineInRect = function(lx1, lz1, ly1, dx, dz, dy, x1, z1, y1, x2, z2, y2) {
        var t1 = (x1 - lx1) * dx;
        var t2 = (x2 - lx1) * dx;
        var t3 = (y1 - ly1) * dy;
        var t4 = (y2 - ly1) * dy;
        var t5 = (z1 - lz1) * dz;
        var t6 = (z2 - lz1) * dz;
        var tmin = Math.max(Math.max(Math.min(t1, t2), Math.min(t3, t4)), Math.min(t5, t6));
        var tmax = Math.min(Math.min(Math.max(t1, t2), Math.max(t3, t4)), Math.max(t5, t6));
        if (tmax < 0) return false;
        if (tmin > tmax) return false;
        return tmin;
    };

    // MutationObserver
    let addObserver = function(elm, check, callback, onshow = true) {
        return new MutationObserver((mutationsList, observer) => {
            if (check == 'src' || onshow && mutationsList[0].target.style.display == 'block' || !onshow) {
                callback(mutationsList[0].target);
            }
        }).observe(elm, check == 'childList' ? {
            childList: true
        } : {
            attributes: true,
            attributeFilter: [check]
        });
    }

    // Event Listener
    let addListener = function(elm, type, callback = null) {
        if (!isDefined(elm)) { alert("Failed creating " + type + "listener"); return }
        elm.addEventListener(type, event => callback(event));
    }

    // Storage
    let canStore = (typeof(Storage) !== "undefined");
    let saveVal = function(name, val) {
        if (canStore) localStorage.setItem(name, val);
    }
    let deleteVal = function(name) {
        if (canStore) localStorage.removeItem(name);
    }
    let getSavedVal = function(name) {
        if (canStore) return localStorage.getItem(name);
        return null;
    }

    //Features
    let newFeature = (name, keyBind, array, myFunction = null) => {
        const cStruct = (...keys) => ((...v) => keys.reduce((o, k, i) => {
            o[k] = v[i];
            return o
        }, {}));
        let item = [];
        const myStruct = cStruct('name', 'key', 'value', 'valueStr', 'container', 'myFunction')
        const value = parseInt(getSavedVal("utilities_" + name) || 0);
        const feature = myStruct(name, keyBind, value, array.length ? array[value] : '', array, myFunction);
        if (array.length || myFunction) features.push(feature);
        item.push(feature);
        return item;
    }

    let getFeature = (name) => {
        for (const feature of features) {
            if (feature.name.toLowerCase() === name.toLowerCase()) {
                return feature;
            }
        }
        return null;
    }

    let onUpdated = (feature) => {
        window.SOUND.play('tick_0', 0.1);
        if (feature.container.length) {
            feature.value += 1;
            if (feature.value > feature.container.length - 1) {
                feature.value = 0;
            }
            feature.valueStr = feature.container[feature.value];
            saveVal("utilities_" + feature.name, feature.value);
        }
        if (feature.container.length == 2 && feature.container[0] == 'Off' && feature.container[1] == 'On') {
            console.debug(feature.name, " is now ", feature.valueStr);
            if (feature.name == "Wallbangs") objectDirty = true;
        }

        if (!updatedFeat.has(feature.name)) {
            console.debug(feature.name, " - Update Pending ")
            updatedFeat.set(feature.name, feature);
        }

        menuDirty = true;
    }

    // Exploit game...
    let hookChain = function(three, utils, colors, config, overlay) {

        overlay.render = new Proxy(overlay.render, {
            apply: function(target, that, [scale, game, controls, renderer, me, delta]) {

                if (me && me.active) {

                    if (!me[vars.get("procInputs").val][isProxy]) {
                        me[vars.get("procInputs").val] = new Proxy(me[vars.get("procInputs").val], {
                            apply: function(target, that, [input, game, recon, lock]) {
                                if (that) INPUTS(three, utils, colors, config, overlay, that, input, game, recon, lock)
                                return target.apply(that, [input, game, recon, lock]);
                            },
                            get: function(target, key) {
                                const value = Reflect.get(target, key)
                                return key === isProxy ? true : value;
                            },
                        })
                    }

                    RENDER(three, utils, colors, config, overlay, scale, game, controls, renderer, me, delta);
                }

                const featureWallbangs = getFeature('Wallbangs');
                if (! game.map.manager.addBlock[isProxy]) {
                    game.map.manager.addBlock = new Proxy(game.map.manager.addBlock, {
                        apply: function(target, that, args) {
                            if (args[7] && args[7].penetrable) {
                                args[7].transparent = featureWallbangs.value ? true : false;
                                args[7].opacity = featureWallbangs.value ? 0.75 : 1.0;
                            }
                            return target.apply(that, args);
                        },
                        get: function(target, key) {
                            const value = Reflect.get(target, key)
                            return key === isProxy ? true : value;
                        }
                    })
                }

                if (objectDirty) {
                    game.map.manager.objects.filter(x => {
                        return x.penetrable
                    }).map((obj, index, array) => {
                        obj.transparent = featureWallbangs.value ? true : false;
                        obj.opacity = featureWallbangs.value ? 0.75 : 1.0;
                    });
                    objectDirty = false;
                }

                return target.apply(that, [scale, game, controls, renderer, me, delta]);
            }
        });
    }

    window.WebSocket = new Proxy(window.WebSocket, {
        construct: function(target, args) {

            const ws = new target(...args);

            // WebSocket "onopen"
            const openHandler = (event) => {
                console.log('Open', event);
            };

            // WebSocket "onmessage"
            const messageHandler = (event) => {
                let typedArray = new Uint8Array(event.data);
                let [id, ...data] = window.msgpack.decode(typedArray);

                switch (id)
                {
                    case "k":
                        {
                            const sz = data[1];
                            const el = data[0];
                            const al = 0x153955f;
                            const mp = 0x3e8;
                            for (let i = 0; i < el.length; ++ i) {
                                if(i == 0 || i % sz == 0) {
                                    let sid = el[i];
                                    let pos = {x:0,y:0,z:0};
                                    pos.x = (el[i + 1] ^ al) / mp
                                    pos.y = (el[i + 2] ^ al) / mp
                                    pos.z = (el[i + 3] ^ al) / mp
                                    positions.set(sid, pos);
                                }
                            }
                        }
                        break;
                }
                // Not changing any data so this is not used atm
                //typedArray = window.msgpack.encode([id, ...data]);
                //Object.defineProperty(event, 'data', {
                //    value: typedArray.buffer
                //});
            };

            // WebSocket "onclose"
            const closeHandler = (event) => {
                console.log('Close', event);
                // remove event listeners
                ws.removeEventListener('open', openHandler);
                ws.removeEventListener('message', messageHandler);
                ws.removeEventListener('close', closeHandler);
            };

            // add event listeners
            ws.addEventListener('open', openHandler);
            ws.addEventListener('message', messageHandler);
            ws.addEventListener('close', closeHandler);

            // proxied send
            ws.send = new Proxy(ws.send, {
                apply: function(target, that, args) {
                    //console.log('Send', args);
                    target.apply(that, args);
                }
            });

            return ws;
        }
    })

    Response.prototype.arrayBuffer = new Proxy(Response.prototype.arrayBuffer, {
        apply: function(target, that, args) {
            const returnValue = target.apply(that, args);
            returnValue.then(buffer => {
                script = decodeText("", new DataView(buffer), 0x69);
                setVars();
                initialize();
            });
            return returnValue;
        }
    })

    Object.freeze = new Proxy(Object.freeze, {
        apply: function(target, that, args) {
            let Caller = arguments.callee.caller;
            if (Caller && Caller.arguments.length == 5 && Caller.arguments[0].ACESFilmicToneMapping) {
                hookChain(...Caller.arguments);
                Object.freeze = target;
            }
            return target.apply(that, args);
        }
    });

    /* Backup Method
    window.TextDecoder.prototype.decode = new Proxy(window.TextDecoder.prototype.decode, {
        apply: function(target, that, args) {
            let returnValue = target.apply(that, args);
            if (returnValue.length > 1050000) {
                script = returnValue;
                setVars();
                initialize();
            }
            return returnValue;
        }
    })
    */

    /* Future Exploit
    Object.setPrototypeOf = new Proxy(Object.setPrototypeOf, {
        apply: function(target, that, args) {
            if (args[0].isPlayer) {
                args[0].module = args[1].$$;
                console.dir(args)
            }
            return target.apply(that, args);
        }
    });
    */
})();
